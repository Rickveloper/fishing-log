<!DOCTYPE html>
<html>
<head>
    <title>Fishing Trip</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f0f0f0;
            margin: 0;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        .map {
            height: 400px;
            margin-top: 20px;
            border-radius: 8px;
        }
        .catch-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        input, select {
            padding: 10px;
            width: 100%;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        button {
            padding: 10px;
            width: 100%;
            background: #007bff;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .catch-entry {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        img {
            max-width: 200px;
            display: block;
            margin-top: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>{{ location or 'None' }} — {{ date or 'None' }}</h2>
        <a href="/trips">View Past Trips</a>
    </div>

    {% set fallback_used = false %}
    {% if catches|length == 0 or (map_center[0] == 43.0362 and map_center[1] == -72.1147) %}
        {% set fallback_used = true %}
    {% endif %}
    {% if fallback_used %}
    <div style="background:#fff3cd;color:#856404;padding:12px;border-radius:6px;margin-bottom:16px;border:1px solid #ffeeba;">
        <strong>Warning:</strong> No GPS found in photo. Pin location is set to map center. You can drag the pin to the correct spot before logging your catch.
    </div>
    {% endif %}
    <div id="map" class="map"></div>

    <form class="catch-form" action="/add-catch?location={{ location }}&date={{ date }}" method="POST" enctype="multipart/form-data" onsubmit="updateLatLonInputs()">
        <h3>Add Catch</h3>
        <div style="margin-bottom:8px; color:#555; font-size:0.97em;">
            <strong>Photo is required.</strong> GPS will be extracted from the photo if available and used for the catch location on the map. You can drag the pin to adjust the location.
        </div>
        <input type="hidden" name="lat" id="catch-lat" value="{{ map_center[0] }}" />
        <input type="hidden" name="lon" id="catch-lon" value="{{ map_center[1] }}" />
        <select name="species" required>
            <option disabled selected>Select Species</option>
            <option>Largemouth Bass</option>
            <option>Smallmouth Bass</option>
        </select>
        <select name="length" required>
            <option disabled selected>Select Length (inches)</option>
            {% for i in range(4, 121) %}
                <option>{{ (i / 4)|round(2) }}</option>
            {% endfor %}
        </select>
        <select name="weight" id="weight-select" required onchange="toggleCustomWeight(this.value)">
            <option disabled selected>Select Weight (lbs)</option>
            {% for i in range(1, 11) %}
                <option>{{ i }}</option>
            {% endfor %}
            <option value="other">Other</option>
        </select>
        <input type="text" name="custom_weight" id="custom-weight" placeholder="Enter custom weight (lbs)" style="display: none;" />
        <input type="text" name="bait" placeholder="Bait Used" required />
        <label style="margin-bottom:6px; font-weight:bold;">Catch Photo (required):</label>
        <input type="file" name="photo" accept="image/*" required style="margin-bottom:16px;" />
        <button type="submit">Log Catch</button>
    </form>

    <h3 style="margin-top: 30px;">Catches</h3>
    {% for c in catches %}
    <div class="catch-entry">
        <strong>{{ c.species }}</strong> — {{ c.length }}" / {{ c.weight }} lbs on {{ c.bait }}
        {% if c.photo %}
        <img src="{{ url_for('static', filename='uploads/' ~ c.photo) }}" onclick="openModal(this.src)">
        {% endif %}
        {% if c.id %}
        <a href="/edit-catch/{{ c.id }}">Edit</a>
        {% endif %}
    </div>
    {% endfor %}
</div>

<div id="imgModal" onclick="this.style.display='none'" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:9999;">
    <img id="modalImg" style="max-width:90%; max-height:90%; border: 4px solid white; box-shadow: 0 0 20px black;">
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    let marker;
    const map = L.map('map').setView([{{ map_center[0]|float }}, {{ map_center[1]|float }}], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    marker = L.marker([{{ map_center[0]|float }}, {{ map_center[1]|float }}], {draggable:true}).addTo(map);
    marker.on('dragend', function(e) {
        const latlng = marker.getLatLng();
        document.getElementById('catch-lat').value = latlng.lat;
        document.getElementById('catch-lon').value = latlng.lng;
    });
    function updateLatLonInputs() {
        const latlng = marker.getLatLng();
        document.getElementById('catch-lat').value = latlng.lat;
        document.getElementById('catch-lon').value = latlng.lng;
    }
    {% for c in catches %}
    {% if c.gps and c.gps|length == 2 %}
    L.marker([{{ c.gps[0]|float }}, {{ c.gps[1]|float }}])
        .addTo(map)
        .bindPopup(`<b>{{ c.species }}</b><br>{{ c.length }} in, {{ c.weight }} lbs<br>{{ c.bait }}<br><img src='{{ url_for('static', filename='uploads/' ~ c.photo) }}' width='100'>`);
    {% endif %}
    {% endfor %}
    function toggleCustomWeight(value) {
        const customInput = document.getElementById('custom-weight');
        if (value === 'other') {
            customInput.style.display = 'block';
            customInput.required = true;
        } else {
            customInput.style.display = 'none';
            customInput.required = false;
        }
    }
    function openModal(src) {
        document.getElementById('modalImg').src = src;
        document.getElementById('imgModal').style.display = 'flex';
    }
</script>
</body>
</html>
